<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="../iron-doc-viewer/iron-doc-viewer.html">

<!--
  Temporary (yeah, right) replacement for <iron-component-page> until
  Polymer 2.0 elements are properly supported.
  Documentation Json can be updated by running `polymer analyze element.html > doc.json`
-->

<dom-module id="api-doc-viewer">
  <template>
    <style>
      :host {
        display: block;
        max-width: 48em;
        padding: 20px;
        margin: 0 auto;
      }
    </style>
    <iron-ajax url="[[url]]" auto last-response="{{_response}}"></iron-ajax>
    <iron-doc-viewer id="viewer" descriptor="[[_descriptor(_response, elementClassName)]]"></iron-doc-viewer>
  </template>
  <script>
    Polymer({
      is: 'api-doc-viewer',

      properties: {
        url: String,
        elementClassName: String
      },

      _descriptor(response, elementClassName) {
        if (!response || !elementClassName) {
          return;
        }

        var descriptor = {};
        var namespace = elementClassName.split('.')[0];

        var element = response.namespaces
            .find(ns => ns.name === namespace)
            .elements
            .find(el => el.classname === elementClassName);

        descriptor.is = element.tagname;
        descriptor.desc = element.description;
        descriptor.properties = element.properties.concat(
          this._methods(element.methods)).map(item => {
          item.type = this._toFirstUpperCase(item.type);
          item.private = item.privacy !== 'public';
          item.desc = item.description;
          item.notify = item.metadata.polymer && item.metadata.polymer.notify;
          item.readOnly = item.metadata.polymer && item.metadata.polymer.readOnly;
          item.default = item.defaultValue;
          return item;
        }).sort((a, b) => {
          return a.name >= b.name ? 1 : -1;
        });

        descriptor.events = this._events(element.events)

        // Envoke hash scrolling navigation after rendering the new descriptor
        setTimeout(() => this.$.viewer.scrollToAnchor(location.hash));

        return descriptor;
      },

      _methods(methods) {
        return methods.map(m => {
          m.type = 'Function';
          m.function = true;
          return m;
        });
      },

      _events(events) {
        return events
          // Currently, analyzer doesn't report notification events
          // from mixin properties so it's better to hide them all
          // for consistency.
          .filter(e => e.name.indexOf('-changed') === -1)
          .map(e => {
            e.desc = e.description;
            return e;
          }).sort((a, b) => {
            return a.name >= b.name ? 1 : -1;
          });
      },

      _toFirstUpperCase(value) {
        return value.substring(0, 1).toUpperCase() + value.substring(1, value.length);
      }
    });
  </script>
</dom-module>
